<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Candyland Portal</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        h1 { text-align: center; }
        .section { border: 1px solid #ccc; border-radius: 8px; padding: 15px; margin: 20px auto; max-width: 600px; }
        button, input[type="text"] { padding: 10px; margin: 5px 0; }
    </style>
</head>
<body>
<h1>Welcome to Candyland Portal</h1>

<div class="section" id="movement-section">
    <h2>Movement</h2>
    <button id="recordMovementBtn">Record movement</button>
    <span id="movementStatus"></span>
    <div id="movementResult"></div>
    <textarea id="movementOutput" readonly style="width:100%;height:120px;margin-top:10px;"></textarea>
    <form id="showMovementForm">
        <button type="submit">Show movement data</button>
    </form>
    <div id="movementData"></div>
</div>

<div style="text-align:center;">
    <a href="/extras">Other features</a> |
    <a href="/show_smiley">Show smiley</a>
</div>

<script>
const recordMovementBtn = document.getElementById('recordMovementBtn');
const movementStatus = document.getElementById('movementStatus');
const movementResult = document.getElementById('movementResult');
const showMovementForm = document.getElementById('showMovementForm');
const movementDataDiv = document.getElementById('movementData');
const movementOutput = document.getElementById('movementOutput');
let movementRecording = false;
let movementInterval = null;
let movementData = [];

recordMovementBtn.addEventListener('click', function() {
    if (!movementRecording) {
        movementData = [];
        movementOutput.value = '';
        movementRecording = true;
        recordMovementBtn.textContent = 'Stop movement recording';
        movementStatus.textContent = ' Recording...';
        movementInterval = setInterval(() => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(pos) {
                    let lat = pos.coords.latitude;
                    let lon = pos.coords.longitude;
                    let timestamp = Date.now();
                    let g = { x: null, y: null, z: null };
                    if (window.DeviceMotionEvent && window.lastG) {
                        g = window.lastG;
                    }
                    const entry = { timestamp, lat, lon, gx: g.x, gy: g.y, gz: g.z };
                    movementData.push(entry);
                    movementOutput.value += JSON.stringify(entry) + '\n';
                });
            }
        }, 1000);
    } else {
        movementRecording = false;
        recordMovementBtn.textContent = 'Record movement';
        movementStatus.textContent = '';
        clearInterval(movementInterval);
        fetch('/record_movement', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: movementData })
        })
        .then(res => res.json())
        .then(data => {
            movementResult.innerHTML = '<b>Movement recorded:</b> ' + (data.status || 'error');
        });
    }
});

showMovementForm.addEventListener('submit', async e => {
    e.preventDefault();
    const res = await fetch('/get_movement');
    const data = await res.json();
    if (data.records && data.records.length > 0) {
        let html = '<h4>Movement Data</h4><table border="1" style="margin:auto;"><tr><th>Timestamp</th><th>Lat</th><th>Lon</th><th>Gx</th><th>Gy</th><th>Gz</th></tr>';
        for (const rec of data.records) {
            html += `<tr><td>${new Date(rec.timestamp).toLocaleString()}</td><td>${rec.lat}</td><td>${rec.lon}</td><td>${rec.gx}</td><td>${rec.gy}</td><td>${rec.gz}</td></tr>`;
        }
        html += '</table>';
        movementDataDiv.innerHTML = html;
    } else {
        movementDataDiv.innerHTML = '<b>No movement data found.</b>';
    }
});

window.lastG = { x: null, y: null, z: null };
if (window.DeviceMotionEvent) {
    window.addEventListener('devicemotion', function(event) {
        if (event.accelerationIncludingGravity) {
            window.lastG = {
                x: event.accelerationIncludingGravity.x,
                y: event.accelerationIncludingGravity.y,
                z: event.accelerationIncludingGravity.z
            };
        }
    });
}
</script>
</body>
</html>
