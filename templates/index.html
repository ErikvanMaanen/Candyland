<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Candyland Portal</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 500px; margin: auto; text-align: center; }
        img { max-width: 200px; margin: 20px 0; }
        button, input[type="text"] { margin: 10px; padding: 10px; }
        #output { margin-top: 20px; color: #333; }
    </style>
</head>
<body>
<div class="container">
    <h1>Welcome to Candyland Portal</h1>
    <form action="/show_smiley" method="get" style="margin-bottom: 20px;">
        <button type="submit">Show Smiley</button>
    </form>
    <form id="scriptNoArgsForm">
        <button type="submit">Run Script (No Args)</button>
    </form>
    <form id="scriptWithArgsForm">
        <input type="text" name="arg" placeholder="Enter argument" required>
        <button type="submit">Run Script (With Args)</button>
    </form>
    <div id="output"></div>
    <hr>
    <h3>Message to self</h3>
    <button id="recordBtn">Message to self</button>
    <span id="recordingStatus"></span>
    <audio id="audioPlayback" controls style="display:none;"></audio>
    <div id="transcription"></div>
</div>
<script>
// Handle script without args
const scriptNoArgsForm = document.getElementById('scriptNoArgsForm');
scriptNoArgsForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const res = await fetch('/run_script_no_args', { method: 'POST' });
    const data = await res.json();
    document.getElementById('output').innerText = data.output;
});
// Handle script with args
const scriptWithArgsForm = document.getElementById('scriptWithArgsForm');
scriptWithArgsForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(scriptWithArgsForm);
    const res = await fetch('/run_script_with_args', {
        method: 'POST',
        body: formData
    });
    const data = await res.json();
    document.getElementById('output').innerText = data.output;
});

// Audio recording logic
let mediaRecorder;
let audioChunks = [];
const recordBtn = document.getElementById('recordBtn');
const recordingStatus = document.getElementById('recordingStatus');
const audioPlayback = document.getElementById('audioPlayback');
const transcriptionDiv = document.getElementById('transcription');

recordBtn.addEventListener('click', async function() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        recordBtn.textContent = 'Message to self';
        recordingStatus.textContent = '';
        return;
    }
    if (!navigator.mediaDevices) {
        alert('Audio recording not supported in this browser.');
        return;
    }
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.ondataavailable = e => {
            if (e.data.size > 0) audioChunks.push(e.data);
        };
        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            audioPlayback.src = URL.createObjectURL(audioBlob);
            audioPlayback.style.display = 'block';
            // Upload audio
            const formData = new FormData();
            formData.append('audio', audioBlob, 'recording.webm');
            const res = await fetch('/record_message', { method: 'POST', body: formData });
            const data = await res.json();
            transcriptionDiv.innerHTML = '<b>Transcription:</b> ' + (data.transcription || '(none)') + '<br><b>Length:</b> ' + data.length + 's';
        };
        mediaRecorder.start();
        recordBtn.textContent = 'Stop Recording';
        recordingStatus.textContent = ' Recording...';
    } catch (err) {
        alert('Could not start audio recording: ' + err);
    }
});
</script>
</body>
</html>
