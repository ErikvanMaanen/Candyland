<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Candyland Portal</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 500px; margin: auto; text-align: center; }
        img { max-width: 200px; margin: 20px 0; }
        button, input[type="text"] { margin: 10px; padding: 10px; }
        #output { margin-top: 20px; color: #333; }
    </style>
</head>
<body>
<div class="container">
    <h1>Welcome to Candyland Portal</h1>
    <hr>
    <h3>Movement</h3>
    <button id="recordMovementBtn">Record movement</button>
    <span id="movementStatus"></span>
    <div id="movementResult"></div>
    <form id="showMovementForm" style="margin-top:10px;">
        <button type="submit">Show movement data</button>
    </form>
    <div id="movementData"></div>
    <hr>
    <h3>Message to self</h3>
    <button id="recordBtn">Message to self</button>
    <span id="recordingStatus"></span>
    <audio id="audioPlayback" controls style="display:none;"></audio>
    <div id="transcription"></div>
    <form id="openArchiveForm" style="margin-top:20px;">
        <button type="submit">Open archive</button>
    </form>
    <div id="archive"></div>
</div>
<script>
// Show movement data
const showMovementForm = document.getElementById('showMovementForm');
const movementDataDiv = document.getElementById('movementData');
showMovementForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const res = await fetch('/get_movement');
    const data = await res.json();
    if (data.records && data.records.length > 0) {
        let html = '<h4>Movement Data</h4><table border="1" style="margin:auto;"><tr><th>Timestamp</th><th>Lat</th><th>Lon</th><th>Gx</th><th>Gy</th><th>Gz</th></tr>';
        for (const rec of data.records) {
            html += `<tr><td>${new Date(rec.timestamp).toLocaleString()}</td><td>${rec.lat}</td><td>${rec.lon}</td><td>${rec.gx}</td><td>${rec.gy}</td><td>${rec.gz}</td></tr>`;
        }
        html += '</table>';
        movementDataDiv.innerHTML = html;
    } else {
        movementDataDiv.innerHTML = '<b>No movement data found.</b>';
    }
});
// Movement recording logic
const recordMovementBtn = document.getElementById('recordMovementBtn');
const movementStatus = document.getElementById('movementStatus');
const movementResult = document.getElementById('movementResult');
let movementRecording = false;
let movementInterval = null;
let movementData = [];

recordMovementBtn.addEventListener('click', function() {
    if (!movementRecording) {
        movementData = [];
        movementRecording = true;
        recordMovementBtn.textContent = 'Stop movement recording';
        movementStatus.textContent = ' Recording...';
        // Start collecting data every second
        movementInterval = setInterval(() => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(pos) {
                    let lat = pos.coords.latitude;
                    let lon = pos.coords.longitude;
                    let timestamp = Date.now();
                    let g = { x: null, y: null, z: null };
                    if (window.DeviceMotionEvent && window.lastG) {
                        g = window.lastG;
                    }
                    movementData.push({ timestamp, lat, lon, gx: g.x, gy: g.y, gz: g.z });
                });
            }
        }, 1000);
    } else {
        movementRecording = false;
        recordMovementBtn.textContent = 'Record movement';
        movementStatus.textContent = '';
        clearInterval(movementInterval);
        // Send data to backend
        fetch('/record_movement', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: movementData })
        })
        .then(res => res.json())
        .then(data => {
            movementResult.innerHTML = '<b>Movement recorded:</b> ' + (data.status || 'error');
        });
    }
});

// Listen for device motion (g-forces)
window.lastG = { x: null, y: null, z: null };
if (window.DeviceMotionEvent) {
    window.addEventListener('devicemotion', function(event) {
        if (event.accelerationIncludingGravity) {
            window.lastG = {
                x: event.accelerationIncludingGravity.x,
                y: event.accelerationIncludingGravity.y,
                z: event.accelerationIncludingGravity.z
            };
        }
    });
}
// Handle Open Archive
const openArchiveForm = document.getElementById('openArchiveForm');
const archiveDiv = document.getElementById('archive');
openArchiveForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const res = await fetch('/get_archive');
    const data = await res.json();
    if (data.records && data.records.length > 0) {
        let html = '<h3>Archive</h3><table border="1" style="margin:auto;"><tr><th>Date</th><th>Filename</th><th>Length (s)</th><th>Transcription</th></tr>';
        for (const rec of data.records) {
            html += `<tr><td>${rec.date}</td><td>${rec.filename}</td><td>${rec.length}</td><td>${rec.transcription || ''}</td></tr>`;
        }
        html += '</table>';
        archiveDiv.innerHTML = html;
    } else {
        archiveDiv.innerHTML = '<b>No records found.</b>';
    }
});
// Handle script without args
const scriptNoArgsForm = document.getElementById('scriptNoArgsForm');
scriptNoArgsForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const res = await fetch('/run_script_no_args', { method: 'POST' });
    const data = await res.json();
    document.getElementById('output').innerText = data.output;
});
// Handle script with args
const scriptWithArgsForm = document.getElementById('scriptWithArgsForm');
scriptWithArgsForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(scriptWithArgsForm);
    const res = await fetch('/run_script_with_args', {
        method: 'POST',
        body: formData
    });
    const data = await res.json();
    document.getElementById('output').innerText = data.output;
});

// Audio recording logic
let mediaRecorder;
let audioChunks = [];
const recordBtn = document.getElementById('recordBtn');
const recordingStatus = document.getElementById('recordingStatus');
const audioPlayback = document.getElementById('audioPlayback');
const transcriptionDiv = document.getElementById('transcription');

recordBtn.addEventListener('click', async function() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        recordBtn.textContent = 'Message to self';
        recordingStatus.textContent = '';
        return;
    }
    if (!navigator.mediaDevices) {
        alert('Audio recording not supported in this browser.');
        return;
    }
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.ondataavailable = e => {
            if (e.data.size > 0) audioChunks.push(e.data);
        };
        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            audioPlayback.src = URL.createObjectURL(audioBlob);
            audioPlayback.style.display = 'block';
            // Upload audio
            const formData = new FormData();
            formData.append('audio', audioBlob, 'recording.webm');
            const res = await fetch('/record_message', { method: 'POST', body: formData });
            const data = await res.json();
            transcriptionDiv.innerHTML = '<b>Transcription:</b> ' + (data.transcription || '(none)') + '<br><b>Length:</b> ' + data.length + 's';
        };
        mediaRecorder.start();
        recordBtn.textContent = 'Stop Recording';
        recordingStatus.textContent = ' Recording...';
    } catch (err) {
        alert('Could not start audio recording: ' + err);
    }
});
</script>
</body>
</html>
